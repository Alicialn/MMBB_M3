<!DOCTYPE html>
<html>
  <head>
    <title>MMBB batery</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./jspsych/dist/graphFunction.js"> </script>
    <script src="https://unpkg.com/jspsych@7.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.0"></script>
    <script src="./jspsych/dist/plugin-audio-button-response.js"> </script>
    <script src="./jspsych/dist/plugin-html-button-response.js"> </script>
    <script src="./jspsych/dist/plugin-survey-text.js"> </script>
    <script src="./jspsych/dist/plugin-html-slider-response.js"> </script>
    <script src="./jspsych/dist/plugin-html-button-response.js"> </script>
    <script src="./jspsych/dist/plugin-survey-html-form.js"> </script>
    <script src="./jspsych/dist/plugin-image-slider-response.js"> </script>
    <script src="./jspsych/dist/plugin-instructions.js"> </script>
    <script src="./jspsych/dist/plugin-free-sort.js"> </script>
    <script src="./jspsych/dist/plugin-survey-likert.js"> </script>
    <script src="./jspsych/dist/plugin-canvas-button-response.js"> </script>
    <script src="./jspsych/dist/extension-accelerometer.js"> </script>
    <script src="./jspsych/dist/plugin-html-keyboard-response.js"> </script>
    <script src="./jspsych/dist/plugin-survey-multi-choice.js"> </script>
    <script src="./jspsych/dist/plugin-initialize-microphone.js"> </script>
    <script src="./jspsych/dist/plugin-html-audio-response.js"> </script>
    <link href="./jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

  </head>
  <body></body>
  <script>

    var jsPsych = initJsPsych({
      extensions: [
        {type: jsPsychExtensionAccelerometer }
      ],
      on_finish: function() {
        //jsPsych.data.displayData();
        jsPsych.data.get().localSave('csv','mydata.csv');
      }
    });

    var instruction1 = {
        type: jsPsychInstructions,
        pages: [
        '<p style="font-size:7vw;">Welcome!</p>',
        '<p style="font-size:7vw;">We are interested in your musical taste</p>',
        '<p style="font-size:7vw;">Tell us 3 songs that you like to dance to</p>',
        '<p style="font-size:7vw;">If possible, give us only youtube links</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    var song1 = {
      type: jsPsychSurveyText,
      questions: [
        {prompt: 'Song 1', required: true},
      ]
    }

    var song2 = {
      type: jsPsychSurveyText,
      questions: [
        {prompt: 'Song 2', required: true},
      ]
    }

    var song3 = {
      type: jsPsychSurveyText,
      questions: [
        {prompt: 'Song 3', required: true},
      ]
    }


    var instruction2 = {
        type: jsPsychInstructions,
        pages: [
        '<p style="font-size:7vw;">Now tell us a bit about yourself</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    var age = {
        type: jsPsychHtmlSliderResponse,
        stimulus: '<div style="font-size:35px">How old are you?</div><div id="showAge" style="font-size:20px">50</div>',
        require_movement: true,
        labels: ['<div style="font-size:20px">0</div>', '<div style="font-size:20px">100+</div>'],
    };
 
    var instruction3 = {
        type: jsPsychInstructions,
        pages: [
        '<p style="font-size:7vw;">Great!</p>',
        '<p style="font-size:7vw;">Your task now is to move freely to the music you chose</p>',
        '<p style="font-size:7vw;">Put your phone inside your pocket</p>',
        '<p style="font-size:7vw;">Or put it inside a backback that you are wearing</p>',
        '<p style="font-size:7vw;">Whatever is easier and feels more comfortable to you</p>',
        '<p style="font-size:7vw;">It\'s important that you do not lock the screen,</p>',
        '<p style="font-size:7vw;">Otherwise the youtube video will stop</p>',
        '<p style="font-size:7vw;">When you click next, the song will start playing</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    function getId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11)
          ? match[2]
          : null;
    }

    function youtubeEmbed(link){
      //Getting only video code to create embed url
      var videoID = getId(link)
      var url = '<iframe style="width: 90vw" width="560" height="315" src="https://www.youtube.com/embed/' + videoID + '?autoplay=1' + '" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; picture-in-picture" allowfullscreen></iframe>'
      return(url)
    }

    var youtubeShow = {
        type: jsPsychInstructions,
        pages: [],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true,
        on_start: function(trial) {
          var allData = jsPsych.data.get().values()
          var link1 = allData[allData.length - 4]['response']['Q0']
          var link2 = allData[allData.length - 5]['response']['Q0']
          var link3 = allData[allData.length - 6]['response']['Q0']
          trial.pages = [youtubeEmbed(link1), youtubeEmbed(link2), youtubeEmbed(link3)]
        }
    }

    jsPsych.run([instruction1, song1, song2, song3, instruction2, age, instruction3, youtubeShow]);

 </script>
</html>
