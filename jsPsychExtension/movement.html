<!DOCTYPE html>
<html>
  <head>
    <title>MMBB battery</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./jspsych/dist/graphFunction.js"> </script>
    <script src="https://unpkg.com/jspsych@7.1.2"></script>
    <script src="./jspsych/dist/plugin-html-songselector-response.js"> </script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.0"></script>
    <script src="./jspsych/dist/plugin-audio-button-response.js"> </script>
    <script src="./jspsych/dist/plugin-html-slider-response.js"> </script>
    <script src="./jspsych/dist/plugin-html-button-response.js"> </script>
    <script src="./jspsych/dist/plugin-instructions.js"> </script>
    <script src="./jspsych/dist/plugin-survey-likert.js"> </script>
    <script src="./jspsych/dist/plugin-canvas-button-response.js"> </script>
    <script src="./jspsych/dist/extension-accelerometer.js"> </script>
    <script src="./jspsych/dist/plugin-html-keyboard-response.js"> </script>
    <script src="./jspsych/dist/plugin-survey-multi-choice.js"> </script>
    <script src="./jspsych/dist/plugin-initialize-microphone.js"> </script>
    <script src="./jspsych/dist/plugin-html-audio-response.js"> </script>
    <script src="./songs/movementTapAudio/songKeysNames.js"> </script>
    <link href="./jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

  </head>
  <body></body>
  <script>

    var jsPsych = initJsPsych({
      extensions: [
        {type: jsPsychExtensionAccelerometer }
      ],
      on_finish: function() {
        //jsPsych.data.displayData();
        jsPsych.data.get().localSave('csv','mydata.csv');
      }
    });

    //first stimulus batch
    // Determining order of presentation of songs to sort.
    var songNames = ["Surround&nbspme&nbspwith&nbspyour&nbsplove&nbsp-&nbspPorter",
                     "Simple&nbspLife&nbsp-&nbspSeeb",
                     "Airborne&nbspRobots&nbsp-&nbspF-777",
                     "Edge&nbsp-&nbspRezz",
                     "Discovered&nbsp-&nbspBeats&nbspAntique", 
                     "Cafe&nbspTropical&nbsp-&nbspJohannes&nbspLinstead", 
                     "Tebel&nbspRousin&nbsp-&nbspHypnotic&nbspBrass&nbspEnsamble", 
                     "Primadonna&nbsp-&nbspSkogsrå",
                     "Ketto&nbsp-&nbspBonobo",
                     "Slow&nbspAcid&nbsp-&nbspCalvin&nbspHarris", 
                     "Temptation&nbsp-&nbspDala"] 

    var songBPMS = ["Surround&nbspme&nbspwith&nbspyour&nbsplove&nbsp-&nbspPorter",
                     "Simple&nbspLife&nbsp-&nbspSeeb",
                     "Airborne&nbspRobots&nbsp-&nbspF-777",
                     "Edge&nbsp-&nbspRezz",
                     "Discovered&nbsp-&nbspBeats&nbspAntique", 
                     "Cafe&nbspTropical&nbsp-&nbspJohannes&nbspLinstead", 
                     "Tebel&nbspRousin&nbsp-&nbspHypnotic&nbspBrass&nbspEnsamble", 
                     "Primadonna&nbsp-&nbspSkogsrå",
                     "Ketto&nbsp-&nbspBonobo",
                     "Slow&nbspAcid&nbsp-&nbspCalvin&nbspHarris", 
                     "Temptation&nbsp-&nbspDala"] 
    var songs = [];
    var songCodes = [];
    var albumCovers = [];
    for (let i = 1; i < 13; i++) {
      if(i != 3){ //song 3 is defectuous
        var s = new Audio();
        s.src = './songs/movementTapAudio/vitrineSongs/' + i + '.mp3';
        songs.push(s)
        songCodes.push(i)
        albumCovers.push('./songs/movementTapAudio/imageAlbums/' + i + '.jpg');
      }
    }

    function PlaySound(song) {
        if(song.paused){
            song.play();
            const color_change = 'blue';
          } else{
            song.pause()
            song.currentTime = 0;
          }
    }

    function othersStop(songList) {
      for(i in songList){
        songList[i].pause()
        songList[i].currentTime = 0;
      }
    }
    
    var chosenSong;
    function setNextSong(sourceSound){
      window.chosenSong = sourceSound;
      console.log(window.chosenSong)
    }

    function displaySongName(songName){
      document.getElementById("songName").innerHTML = songName
    }

    var prompt_songs = function(listSongs, songCodes){
          html = "<div id='songName'>Choose a song below and click nex when you have made your choice</div>"
          for(i in listSongs){
            var songPath = listSongs[i].src
            var songName = songNames[i]
            var songCode = songCodes[i]
            html += "<audio></audio> <button id='buttonSongItem' name='buttonMusic' onclick=" + "othersStop(songs);PlaySound(songs[" + i + "]);changeColor(this);setNextSong('" + songCode + "');><img id='coverImage' src="+albumCovers[i]+"></button>"
          }
          html += "</div>"
          return(html)
    };

    function changeColor(btn) {
        var buttonsList = document.getElementsByName("buttonMusic");
        for (let i = 0; i < buttonsList.length; i++) {
          buttonsList[i].style.backgroundColor = "lightgray"
        }

        if(btn.style.backgroundColor !== 'lightblue'){
            btn.style.backgroundColor = "lightblue";
            } else{
            btn.style.backgroundColor = "lightgray";
          }
    }
        
    var chooseSongs = {
      type: jsPsychHtmlSongSelectorResponse,
      stimulus: prompt_songs(songs, songCodes),
      choices: ["Next"],
      on_finish: function(){
        for(k in songs){
          songs[k].pause()
        }
      },
    };

    var frontPage = {
        type: jsPsychInstructions,
        pages: [
        '<p style="font-size:7vw;">Welcome to the Movement task</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }
    

    var loadAccel = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: './songs/movementTapAudio/silence.wav',
        prompt: '<p style="font-size:45px;">Authorize access to accelerometer</p>',
        trial_duration: 3000,
        choices: ["NO_KEYS"],
        extensions: [
          {type: jsPsychExtensionAccelerometer }
        ],
    }

    var instruction0 = {
        type: jsPsychInstructions,
        pages: [
        '<p style="font-size:7vw;">Movement task</p>',
        '<p style="font-size:7vw;">In the following tasks, you will be asked to perform body movements in different situations</p>',
        '<p style="font-size:7vw;">Between each task, you will have a chance to take breaks</p>',
        '<p style="font-size:7vw;">Your body movements will be recorded using the accelerometers of your phone</p>',
        '<p style="font-size:7vw;">In order for you to move freely, we ask you to put your phone on your pocket before before each task starts</p>',
        '<p style="font-size:7vw;">There is no need to lock the screen of your phone</p>',
        '<p style="font-size:7vw;">Before each task, you will hear a voice countdown indicating that it is about to start</p>',
        '<p style="font-size:7vw;">There will also another voice indicating that the task ended</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }
    
    //'<p style="font-size:7vw;">Feel free to take breaks between the tasks to drink or have a rest</p>',

    var instruction1 = {
        type: jsPsychInstructions,
        pages: [
        '<p style="font-size:7vw;">In the first task, you will be asked to walk at a comfortable speed</p>',
        '<p style="font-size:6vw;">Try to find a space where you can walk at the speed that is most natural for you</p>',
        '<p style="font-size:6vw;">Click next when you are ready to begin</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    var instruction2 = {
        type: jsPsychInstructions,
        pages: [
        '<p style="font-size:7vw;">Now you will hear a song.</p>',
        '<p style="font-size:7vw;">Your task is to bounce along with the beat of the song.</p>',
        '<p style="font-size:7vw;">This is an example of bouncing <br><video id="myVideo" width="100%" controls><source src="./songs/movementTapAudio/instructionsAudio/bouncing.mp4" type="video/mp4"></video>',
        '<p style="font-size:7vw;">Try to bounce in a way that feels natural to you</p>',
        '<p style="font-size:7vw;">Also, try to remain in place and to avoid any other movements besides the bouncing motion.</p>',
        '<p style="font-size:6vw;">Click next when you are ready to begin</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    var instruction3 = {
        type: jsPsychInstructions,
        pages: [
        '<p style="font-size:7vw;">Now you are asked to move to a musical pieces in a way that feels natural to you</p>',
        '<p style="font-size:7vw;">Feel free to dance to the music if you want to</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    var instruction4 = {
        type: jsPsychInstructions,
        pages: [
        '<p style="font-size:7vw;">Now we will ask you to choose a song that you would dance to</p>',
        '<p style="font-size:7vw;">Move to the song in way that feels natural to you</p>',
        '<p style="font-size:7vw;">Feel free to dance to the music if you want to</p>',
        '<p style="font-size:7vw;">When you click next, you will see many album covers representing a particular song</p>',
        '<p style="font-size:7vw;">Click on the album cover to hear the song</p>',
        '<p style="font-size:7vw;">When you have made your choice, scroll down to the bottom of the page and click on the continue button</p>',
        '<p style="font-size:7vw;">Click next when you are ready to begin</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    var familiarityRating = {
        type: jsPsychHtmlSliderResponse,
        stimulus: '',
        stimulus: `<div style="width:500px;">
            <p>Please rate your level of familiarity with this piece of music?</p>
            <div style="width:240px; float: left;">
              <p>10 wins, 5 losses, 6 draws</p>
            </div>
            <div style="width:240px; float: right;">
              <p>6 wins, 4 losses, 11 draws</p>
            </div>
            </div>`,
        require_movement: true,
        //labels: ["never heard it before", "may have heard it before", "know the song and certain that you have heard it before", "heard it several times before", "know this song so well that<br>I can predict what happens next in the song"],
        labels: ["0", "1", "2", "3", "4"]
    };

    var phonePocket = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: './songs/movementTapAudio/instructionsAudio/phonePocket.mp3',
        prompt: '<p style="font-size:45px;">Please put your phone in your pocket</p>',
        trial_duration: 7000,
        choices: ["NO_KEYS"],
    }

    var countDown = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: './songs/movementTapAudio/instructionsAudio/countdown.mp3',
        prompt: '<p style="font-size:45px;"></p>',
        trial_duration: 6500,
        choices: ["NO_KEYS"],
    }

    var pickUpPhone = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: './songs/movementTapAudio/instructionsAudio/pickPhone.mp3',
        prompt: '<p style="font-size:45px;"></p>',
        choices: ["NO_KEYS"],
        trial_duration: 10000,
    }

    var trialAccelerometer1 = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: './songs/movementTapAudio/silence.wav',
        prompt: '<p style="font-size:45px;">Walk</p>',
        trial_duration: 15000,
        choices: ["NO_KEYS"],
        extensions: [
          {type: jsPsychExtensionAccelerometer }
        ],
    }
    
    const random = (min, max) => Math.floor(Math.random() * (max - min)) + min;
    var randomHemiolaIndex = random(0, songKeys['14'].length -1)

    var randomHemiolaSong = songKeys['14'][randomHemiolaIndex]
    console.log(randomHemiolaSong)

    var trialAccelerometer2 = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: './songs/movementTapAudio/modifiedAudio/' + randomHemiolaSong,
        prompt: '<p style="font-size:45px;">Bounce</p>',
        trial_duration: 15000,
        choices: ["NO_KEYS"],
        extensions: [
          {type: jsPsychExtensionAccelerometer }
        ],
    }

    var randomElPesebreIndex = random(0, songKeys['13'].length -1)
    var randomElPesebreSong = songKeys['13'][randomElPesebreIndex]

    console.log(randomElPesebreSong)

    var trialAccelerometer3 = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: './songs/movementTapAudio/modifiedAudio/' + randomElPesebreSong,
        prompt: '<p style="font-size:45px;">Move freely</p>',
        trial_duration: 30000,
        choices: ["NO_KEYS"],
        extensions: [
          {type: jsPsychExtensionAccelerometer }
        ],
    }

    var trialAccelerometer4 = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: '',
        prompt: '<p style="font-size:45px;">Move freely</p>',
        trial_duration: 30000,
        choices: ["NO_KEYS"],
        extensions: [
          {type: jsPsychExtensionAccelerometer }
        ],
        on_start: function(trial) {
            var allData = jsPsych.data.get().values()
            //var chosenS = allData[allData.length - 3].chosen
            var chosenSongCode = window.chosenSong
            var randomChosenIndex = random(0, songKeys[chosenSongCode].length -1)
            var randomChosenSong = songKeys[chosenSongCode][randomChosenIndex]
            console.log(randomChosenSong)
            trial.stimulus = './songs/movementTapAudio/modifiedAudio/' + randomChosenSong
        },
    }


    function drawGraph(c){
        var ctx = c;
        var lasttimelinedata = jsPsych.data.getLastTimelineData().trials[1].accelerometer_data;
        var x = []
        var y = []
        var z = []
        var t = []
        for(var p of lasttimelinedata){
              x.push(p.x)
              y.push(p.y)
              z.push(p.z)
              t.push(p.t)
        }
        var yAxis = [x, y, z];
        graphCustom(t, yAxis, ['x', 'y', 'z'], ctx, 'line')
    }

    var displayAccel = {
        type: jsPsychCanvasButtonResponse,
        canvas_size: [250, 500],
        stimulus: drawGraph,
        choices: ['Next'],
    }

    //jsPsych.run([familiarityRating])
    jsPsych.run([frontPage, loadAccel, instruction0, instruction1, phonePocket, countDown, trialAccelerometer1, pickUpPhone, instruction2, phonePocket, countDown, trialAccelerometer2, pickUpPhone,  instruction3, phonePocket, countDown, trialAccelerometer3, pickUpPhone, instruction4, chooseSongs, phonePocket, countDown, trialAccelerometer4, pickUpPhone]);

 </script>
</html>
