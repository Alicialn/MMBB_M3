<!DOCTYPE html>
<html>
<body style="background-color: lightgray">

<h1>Slide to hear and adjust the beat</h1>
<button onclick="startExp(250, [1, 0, 1, 0], audio1, audio2)">Start beat</button>
<button onclick="stop()">Stop beat</button>

<div class="slidecontainer">
  <input type="range" min="-2" max="2" value="0" class="slider" id="myRange">
  <div id="show"></div>
</div>

<h1>Beat to be adjusted</h1>
<div style='display: flex; float: left; font-size: 50px; color: white'>
<div id="0" style='margin: 10px; padding: 20; background-color:lightblue'>1</div>
<div id="1" style='margin: 10px; padding: 20; background-color:lightblue'>0</div>
<div id="2" style='margin: 10px; padding: 20; background-color:lightblue'>1</div>
<div id="3" style='margin: 10px; padding: 20; background-color:lightblue'>0</div>
</div>


</body>

<script>

var audio1 = new Audio('./beat.wav');
var audio2 = new Audio('./emotion_demo/final_stimuli/072.mp3');
audio2.loop = true;

function audioPlayer(audioFile){
  audioFile.pause()
  audioFile.currentTime = 0
  audioFile.play()
}

var barLoop;
var barRun;

//Makes loop within one bar
const barMaker = (bpm, beatStructure, audioFile)=>{
  for (let i = 0; i <= 3; i++) {
      barRun = setTimeout( () =>{
        if(beatStructure[i] === 1){
            audioPlayer(audioFile)
            document.getElementById("0").style.backgroundColor = 'lightblue'
            document.getElementById("1").style.backgroundColor = 'lightblue'
            document.getElementById("2").style.backgroundColor = 'lightblue'
            document.getElementById("3").style.backgroundColor = 'lightblue'
            document.getElementById(i).style.backgroundColor = 'blue'
        }
      }, i * bpm)
    }
}

function stop(){
  clearInterval(barLoop)
  clearTimeout(barRun)
}

//Clears previous loops and starts new one
function startAdjustBeat(bpm, beatStructure, audioFile){
  stop()
  barRun = barMaker(bpm, beatStructure, audioFile) // i
  barLoop = setInterval( function(){barMaker(bpm, beatStructure, audioFile)}, bpm*4)
}

//Function initiates base beat and beat to be aligned
function startExp(bpm, beatStructure, beatAudio, baseAudio){
  audioPlayer(baseAudio) //starts base audio
  startAdjustBeat(bpm, beatStructure, beatAudio) //Starts audio to be adjusted

}

function arrayRotate(arr, count) {
  count -= arr.length * Math.floor(count / arr.length);
  arr.push.apply(arr, arr.splice(0, count));
  return arr;
}

var slide = document.getElementById("myRange")
slide.addEventListener('change', function(){

    beatStructure = [1, 0, 1, 0]

    newBeatStructure = arrayRotate(beatStructure, this.value)

    document.getElementById("0").innerHTML = newBeatStructure[0]
    document.getElementById("1").innerHTML = newBeatStructure[1]
    document.getElementById("2").innerHTML = newBeatStructure[2]
    document.getElementById("3").innerHTML = newBeatStructure[3]
    
    stop()
    startAdjustBeat(250, newBeatStructure, audio1, audio2)

  }
);



</script>

</html>





