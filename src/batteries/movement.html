<!DOCTYPE html>
<html>
  <head>
    <title>MMBB battery</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../../jspsych/dist/graphFunction.js"> </script>
    <script src="https://unpkg.com/jspsych@7.1.2"></script>
    <script src="../../jspsych/dist/plugin-html-songselector-response.js"> </script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.0"></script>
    <script src="../../jspsych/dist/plugin-html-slider-response.js"></script>
    <script src="../../jspsych/dist/plugin-audio-button-response.js"> </script>
    <script src="../../jspsych/dist/plugin-html-button-response.js"> </script>
    <script src="../../jspsych/dist/plugin-instructions.js"> </script>
    <script src="../../jspsych/dist/plugin-survey-likert.js"> </script>
    <script src="../../jspsych/dist/plugin-canvas-button-response.js"> </script>
    <script src="../../jspsych/dist/extension-accelerometer.js"> </script>
    <script src="../../jspsych/dist/plugin-html-keyboard-response.js"> </script>
    <script src="../../jspsych/dist/plugin-survey-multi-choice.js"> </script>
    <script src="../../jspsych/dist/plugin-initialize-microphone.js"> </script>
    <script src="../../jspsych/dist/plugin-html-audio-response.js"> </script>
    <script src="../../jspsych/dist/plugin-preload.js"> </script>
    <script src="../../songs/movementTapAudio/songKeysNames.js"> </script>
    <script src="../../jspsych/dist/custom/utils.js"> </script>
    <!--<link href="../../jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />-->
    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.1.2/css/jspsych.css">
    <link rel="stylesheet" href="./generalCSS.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  </head>
  <body></body>
  <script>

    var jsPsych = initJsPsych({
      extensions: [
        {type: jsPsychExtensionAccelerometer }
      ],
      on_finish: function() {
        //jsPsych.data.displayData();
        jsPsych.data.get().localSave('csv','mydata.csv');
      }
    });

    //first stimulus batch
    // Determining order of presentation of songs to sort.
    var songNames = ["Surround&nbspme&nbspwith&nbspyour&nbsplove&nbsp-&nbspPorter",
                     "Simple&nbspLife&nbsp-&nbspSeeb",
                     "Airborne&nbspRobots&nbsp-&nbspF-777",
                     "Edge&nbsp-&nbspRezz",
                     "Discovered&nbsp-&nbspBeats&nbspAntique", 
                     "Cafe&nbspTropical&nbsp-&nbspJohannes&nbspLinstead", 
                     "Tebel&nbspRousin&nbsp-&nbspHypnotic&nbspBrass&nbspEnsamble", 
                     "Primadonna&nbsp-&nbspSkogsrå",
                     "Ketto&nbsp-&nbspBonobo",
                     "Slow&nbspAcid&nbsp-&nbspCalvin&nbspHarris", 
                     "Temptation&nbsp-&nbspDala"] 

    var songBPMS = ["Surround&nbspme&nbspwith&nbspyour&nbsplove&nbsp-&nbspPorter",
                     "Simple&nbspLife&nbsp-&nbspSeeb",
                     "Airborne&nbspRobots&nbsp-&nbspF-777",
                     "Edge&nbsp-&nbspRezz",
                     "Discovered&nbsp-&nbspBeats&nbspAntique", 
                     "Cafe&nbspTropical&nbsp-&nbspJohannes&nbspLinstead", 
                     "Tebel&nbspRousin&nbsp-&nbspHypnotic&nbspBrass&nbspEnsamble", 
                     "Primadonna&nbsp-&nbspSkogsrå",
                     "Ketto&nbsp-&nbspBonobo",
                     "Slow&nbspAcid&nbsp-&nbspCalvin&nbspHarris", 
                     "Temptation&nbsp-&nbspDala"] 
    var songs = [];
    var songCodes = [];
    var albumCovers = [];
    for (let i = 1; i < 7; i++) {
        var s = new Audio();
        s.src = '../../songs/movementTapAudio/vitrineSongs/' + i + '.mp3';
        songs.push(s)
        songCodes.push(i)
        albumCovers.push('../../songs/movementTapAudio/imageAlbums/' + i + '.jpg');
    }

    function PlaySound(song) {
        if(song.paused){
            song.play();
            const color_change = 'blue';
          } else{
            song.pause()
            song.currentTime = 0;
          }
    }

    function othersStop(songList) {
      for(i in songList){
        songList[i].pause()
        songList[i].currentTime = 0;
      }
    }
    
    var chosenSong;
    function setNextSong(sourceSound){
      window.chosenSong = sourceSound;
      console.log(window.chosenSong)
    }

    function displaySongName(songName){
      document.getElementById("songName").innerHTML = songName
    }

    var prompt_songs = function(listSongs, songCodes){
          html = "<div id='songName'>Choose a song below and click nex when you have made your choice</div>"
          for(i in listSongs){
            var songPath = listSongs[i].src
            var songName = songNames[i]
            var songCode = songCodes[i]
            html += "<audio></audio> <button id='buttonSongItem' name='buttonMusic' onclick=" + "othersStop(songs);PlaySound(songs[" + i + "]);changeColor(this);setNextSong('" + songCode + "');><img id='coverImage' src="+albumCovers[i]+"></button>"
          }
          html += "</div>"
          return(html)
    };

    function changeColor(btn) {
        var buttonsList = document.getElementsByName("buttonMusic");
        for (let i = 0; i < buttonsList.length; i++) {
          buttonsList[i].style.backgroundColor = "lightgray"
        }

        if(btn.style.backgroundColor !== 'lightblue'){
            btn.style.backgroundColor = "lightblue";
            } else{
            btn.style.backgroundColor = "lightgray";
          }
    }
    
    var randomChosenSong;
    var chooseSongs = {
      type: jsPsychHtmlSongSelectorResponse,
      stimulus: prompt_songs(songs, songCodes),
      choices: ["Next"],
      on_finish: function(){
        for(k in songs){
          songs[k].pause()
        }
        console.log(window.chosenSong)
        var chosenSongCode = window.chosenSong
        var randomChosenIndex = random(0, songKeys[chosenSongCode].length -1)
        window.randomChosenSong = songKeys[chosenSongCode][randomChosenIndex]
        console.log(window.randomChosenSong)
      },
    };

    var frontPage = {
        type: jsPsychInstructions,
        pages: [
        'Welcome to the Movement task',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }
    

    var loadAccel = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: '../../songs/movementTapAudio/silence.wav',
        prompt: 'Accessing accelerometer<br><img id="logoLoading" src="../../images/loading.gif">',
        trial_duration: 3000,
        choices: ["NO_KEYS"],
        extensions: [
          {type: jsPsychExtensionAccelerometer }
        ],
    }

    var instruction0 = {
        type: jsPsychInstructions,
        pages: [
        'Movement task',
        'In the following tasks, you will be asked to perform body movements in different situations',
        'Between each task, you will have a chance to take breaks',
        'Your body movements will be recorded using the accelerometers of your phone',
        'In order for you to move freely, we ask you to put your phone on your pocket before before each task starts',
        'There is no need to lock the screen of your phone',
        'Before each task, you will hear a voice countdown indicating that it is about to start',
        'There will also another voice indicating that the task ended',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }
    
    //'Feel free to take breaks between the tasks to drink or have a rest</p>',

    var instruction1 = {
        type: jsPsychInstructions,
        pages: [
        'In the first task, you will be asked to walk at a comfortable speed',
        'Try to find a space where you can walk at the speed that is most natural for you',
        'Click next when you are ready to begin',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    var instruction2 = {
        type: jsPsychInstructions,
        pages: [
        'Now you will hear a song.</p>',
        'Your task is to bounce along with the beat of the song.</p>',
        'This is an example of bouncing ' + '<br><video id="myVideo" width="100%" controls><source src="../../songs/movementTapAudio/instructionsAudio/bouncing.mp4" type="video/mp4"></video>',
        'Try to bounce in a way that feels natural to you</p>',
        'Also, try to remain in place and to avoid any other movements besides the bouncing motion.</p>',
        '<p style="font-size:6vw;">Click next when you are ready to begin</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    var instruction3 = {
        type: jsPsychInstructions,
        pages: [
        'Now you are asked to move to a musical pieces in a way that feels natural to you</p>',
        'Feel free to dance to the music if you want to</p>',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    var instruction4 = {
        type: jsPsychInstructions,
        pages: [
        'Now we will ask you to choose a song that you would dance to',
        'Move to the song in way that feels natural to you',
        'Feel free to dance to the music if you want to',
        'When you click next, you will see many album covers representing a particular song',
        'Click on the album cover to hear the song',
        'When you have made your choice, scroll down to the bottom of the page and click on the continue button',
        'Click next when you are ready to begin',
        ],
        button_label_next: "Next",
        button_label_previous: "Previous",
        show_clickable_nav: true
    }

    var familiarityRating = {
        type: jsPsychHtmlSliderResponse,
        stimulus: "How familiar are you with the piece of music that you just heard?",
        require_movement: true,
        labels: ['I Never heard it before', 
                 'I know this song so well that I can predict what happens next in the song'],
        on_load: function(){
          //Reset jsPsych styling
          document.getElementById("label0").style = ''
          document.getElementById("label1").style = ''
        },
        on_finish: function(data){
          var allData = jsPsych.data.get().values();
          var song = allData[allData.length - 2].stimulus;
          data.song = song;
        }
    };

    var likingRating = {
        type: jsPsychHtmlSliderResponse,
        stimulus: "How much did you like the music that you just heard",
        require_movement: true,
        labels: ["I did not like it at all", "I liked it a lot"],
        on_load: function(){
          document.getElementById("label0").style = ''
          document.getElementById("label1").style = ''
        },
        on_finish: function(data){
          var allData = jsPsych.data.get().values();
          var song = allData[allData.length - 3].stimulus;
          data.song = song;
        }
    };

    var grooveRating = {
        type: jsPsychHtmlSliderResponse,
        stimulus: "How much did this piece of music make you want to move",
        require_movement: true,
        labels: ["Not at all", "A lot"],
        on_load: function(){
          document.getElementById("label0").style = ''
          document.getElementById("label1").style = ''
        },
        on_finish: function(data){
          var allData = jsPsych.data.get().values();
          var song = allData[allData.length - 4].stimulus;
          data.song = song;
        }
    };

    var phonePocket = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: '../../songs/movementTapAudio/instructionsAudio/phonePocket.mp3',
        prompt: 'Please put your phone in your pocket',
        trial_duration: 7000,
        choices: ["NO_KEYS"],
    }

    var countDown = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: '../../songs/movementTapAudio/instructionsAudio/countdown.mp3',
        prompt: '',
        trial_duration: 6500,
        choices: ["NO_KEYS"],
    }

    var pickUpPhone = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: '../../songs/movementTapAudio/instructionsAudio/pickPhone.mp3',
        prompt: '',
        choices: ["NO_KEYS"],
        trial_duration: 10000,
    }

    var trialAccelerometer1 = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: '../../songs/movementTapAudio/silence.wav',
        prompt: 'Walk',
        trial_duration: 15000,
        choices: ["NO_KEYS"],
        extensions: [
          {type: jsPsychExtensionAccelerometer }
        ],
    }
    
    var randomHemiolaIndex = random(0, songKeys['8'].length -1)
    var randomHemiolaSong = songKeys['8'][randomHemiolaIndex]

    var randomElPesebreIndex = random(0, songKeys['7'].length -1)
    var randomElPesebreSong = songKeys['7'][randomElPesebreIndex]

    console.log(randomHemiolaSong)
    console.log(randomElPesebreSong)

    var trialAccelerometer2 = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: '../../songs/movementTapAudio/modifiedAudio/' + randomHemiolaSong,
        prompt: 'Bounce',
        trial_duration: 15000,
        choices: ["NO_KEYS"],
        extensions: [
          {type: jsPsychExtensionAccelerometer }
        ],
    }

    var songsToPreload = [randomElPesebreSong, randomHemiolaSong]
    var songPaths = '../../songs/movementTapAudio/modifiedAudio/'
    var pathsToPreload = songsToPreload.map(i=>songPaths+i)
    var preloadSongs = {
      type: jsPsychPreload,
      audio: pathsToPreload 
    }   

    var preloadChosen = {
      type: jsPsychPreload,
      audio: window.randomChosenSong,
    }   


    var trialAccelerometer3 = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: '../../songs/movementTapAudio/modifiedAudio/' + randomElPesebreSong,
        prompt: 'Move freely',
        trial_duration: 30000,
        choices: ["NO_KEYS"],
        extensions: [
          {type: jsPsychExtensionAccelerometer }
        ],
    }

    var trialAccelerometer4 = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: '',
        prompt: 'Move freely',
        trial_duration: 30000,
        choices: ["NO_KEYS"],
        extensions: [
          {type: jsPsychExtensionAccelerometer }
        ],
        on_start: function(trial) {
            var allData = jsPsych.data.get().values()
            trial.stimulus = '../../songs/movementTapAudio/modifiedAudio/' + window.randomChosenSong
        },
    }

    //jsPsych.run([familiarityRating])
    jsPsych.run([preloadSongs, frontPage, loadAccel, instruction0, instruction1, phonePocket, countDown, trialAccelerometer1, pickUpPhone, instruction2, phonePocket, countDown, trialAccelerometer2, pickUpPhone, familiarityRating, likingRating, grooveRating, instruction3, phonePocket, countDown, trialAccelerometer3, pickUpPhone, familiarityRating, likingRating, grooveRating, instruction4, chooseSongs, preloadChosen, phonePocket, countDown, trialAccelerometer4, pickUpPhone, familiarityRating, likingRating, grooveRating]);
    //jsPsych.run([chooseSongs, phonePocket, countDown, trialAccelerometer4, familiarityRating, likingRating]);

 </script>
</html>
